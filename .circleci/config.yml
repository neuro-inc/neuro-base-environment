version: 2

defaults: &defaults
  docker:
    - image: docker:19.03-rc-git
  working_directory: /template-base-image

jobs:
  build:
    <<: *defaults
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run: &install_dependencies
          name: Install dependencies
          command: apk add --no-cache --no-progress make python3==3.7.4-r0
      - run: &build_image
          name: Build application Docker image
          command: echo ok #make image
      - run:
            name: Prepare testing environment
            command: |
              # Since we use remote docker, in order to mount `testing/` folder to the container, we need to copy it first.
              # Source: https://circleci.com/docs/2.0/building-docker-images/#mounting-folders
              # create a dummy container which will hold a volume with config:
              docker create -v /testing --name=aux alpine /bin/true
              # copy testing folder into this volume:
              docker cp testing/ aux:/
      - run:
            name: Run tests
            command: |
              make test_image  TEST_IMAGE_DOCKER_MOUNT_OPTION="--volumes-from=aux"  TEST_IMAGE_DOCKER_NAME_OPTION="--name=test-image-container"
              make test_timeout
            no_output_timeout: 30m
      - run:
            name: Download logs dir from the remote docker
            command: docker cp test-image-container:/testing/logs testing/
      - store_artifacts:
          path: testing/logs/stdout.txt
          destination: stdout.txt
      - store_artifacts:
          path: testing/logs/stderr.txt
          destination: stderr.txt

  deploy:
    <<: *defaults
    steps:
      - checkout
      - setup_remote_docker
      - run: *install_dependencies
      - run: *build_image
      - run:
          name: Publish Docker Image to Docker Hub
          command: |
            docker login -u "$DOCKERHUB_NAME" -p "$DOCKERHUB_PASSWORD"
            docker push neuromation/base:latest

workflows:
  version: 2
  main:
    jobs:
      - build
      - deploy:
          filters:
            branches:
              only: master
