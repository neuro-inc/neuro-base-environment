version: 2

defaults: &defaults
  docker:
    - image: docker:17.05.0-ce-git
  working_directory: /template-base-image

jobs:
  build:
    <<: *defaults
    steps:
      - checkout
      - setup_remote_docker
      - run: &install_dependencies
            name: Install dependencies
            command: apk add --no-cache make python3
      - run: &build_image
            name: Build application Docker image
            command: make image
      - run:
            name: Run tests
            command: make test
  deploy:
    <<: *defaults
    steps:
      - checkout
      - setup_remote_docker
      - run: *install_dependencies
      - run: *build_image
      - run:
          name: Publish Docker Image to Docker Hub
          command: |
            docker login -u "$DOCKERHUB_NAME" -p "$DOCKERHUB_PASSWORD"
            docker push neuromation/base:latest

workflows:
  version: 2
  main:
    jobs:
      - build
      - deploy:
          filters:
            branches:
              only: master
