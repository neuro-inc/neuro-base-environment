name: Continuous Integration

on:
  pull_request:
  release:
    types: [published]
  push:
    branches: [master]

jobs:
  build:
    env:
      DOCKERFILE_VERSION: python37-jupyter-pytorch-tensorflow-jupyterlab
      IMAGE_NAME: neuromation/base
    
    name: Build, test and publish image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout commit
        uses: actions/checkout@v2

      - name: Show diff
        run: |
            make image_diff

      - name: Login DockerHub
        env:
          DOCKER_SERVER: docker.io
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD $DOCKER_SERVER

      - name: Build image
        run: |
            make image_build

      - name: List pip packages
        run: |
            make image_pip_list

      - name: Test image
        run: |
            make e2e_neuro_push
            make test_e2e_pytorch
            make test_e2e_tensorflow
 
      - name: Push master
        if: github.ref == 'refs/heads/master'
        run: |
          export GIT_TAGS="master-$(date +%Y%m%d)-$GITHUB_RUN_NUMBER"
          make image_deploy

      - name: Push release
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          export GIT_TAGS="latest,${GITHUB_REF#refs/tags/}"
          make image_deploy
